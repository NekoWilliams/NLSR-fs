# processing-weightの調整

## 変更の目的

リンクコスト25に対して、FunctionCostが3000や10000と大きすぎるため、より適切な範囲（数十から100弱）に調整しました。

## 変更内容

### 変更前
```conf
processing-weight  10000
```

### 変更後
```conf
processing-weight  100
```

## 変更による影響

### 変更前の計算例

**利用率30%（0.3）の場合:**
```
FunctionCost = 0.3 * 10000 = 3000
最終コスト = 25 + 3000 = 3025
```

**利用率100%（1.0）の場合:**
```
FunctionCost = 1.0 * 10000 = 10000
最終コスト = 25 + 10000 = 10025
```

### 変更後の計算例

**利用率30%（0.3）の場合:**
```
FunctionCost = 0.3 * 100 = 30
最終コスト = 25 + 30 = 55
```

**利用率100%（1.0）の場合:**
```
FunctionCost = 1.0 * 100 = 100
最終コスト = 25 + 100 = 125
```

## 利用率とFunctionCostの関係（新設定）

| 利用率 | FunctionCost | リンクコスト25の場合の最終コスト |
|--------|--------------|--------------------------------|
| 0%     | 0            | 25                             |
| 10%    | 10           | 35                             |
| 20%    | 20           | 45                             |
| 30%    | 30           | 55                             |
| 40%    | 40           | 65                             |
| 50%    | 50           | 75                             |
| 60%    | 60           | 85                             |
| 70%    | 70           | 95                             |
| 80%    | 80           | 105                            |
| 90%    | 90           | 115                            |
| 100%   | 100          | 125                            |

## トラフィック分散への影響

### 例: node1とnode2の両方が/relayを提供している場合

**初期状態（利用率0%）:**
- node1へのリンクコスト: 50
- node2へのリンクコスト: 25
- node2の方が低コスト → すべてのトラフィックがnode2にルーティング

**node2の利用率が30%になった場合:**
- node1へのリンクコスト: 50（FunctionCost = 0）
- node2へのリンクコスト: 25 + 30 = 55（FunctionCost = 30）
- node1の方が低コスト → すべてのトラフィックがnode1にルーティング

**node1の利用率が30%、node2の利用率が20%の場合:**
- node1へのリンクコスト: 50 + 30 = 80（FunctionCost = 30）
- node2へのリンクコスト: 25 + 20 = 45（FunctionCost = 20）
- node2の方が低コスト → すべてのトラフィックがnode2にルーティング

**node1の利用率が10%、node2の利用率が50%の場合:**
- node1へのリンクコスト: 50 + 10 = 60（FunctionCost = 10）
- node2へのリンクコスト: 25 + 50 = 75（FunctionCost = 50）
- node1の方が低コスト → すべてのトラフィックがnode1にルーティング

## 調整の効果

1. **適切なコスト範囲**: リンクコスト25に対して、FunctionCostは0~100の範囲で、最終コストは25~125の範囲になります。

2. **バランスの取れた負荷分散**: リンクコストとFunctionCostのバランスが取れ、より自然な負荷分散が実現されます。

3. **細かい調整が可能**: 利用率の小さな違いでも、ルーティングが適切に変化します。

## 変更したファイル

- `/home/katsutoshi/nlsr-sample-k8s/nlsr-node1.conf`
- `/home/katsutoshi/nlsr-sample-k8s/nlsr-node2.conf`

## 次のステップ

1. **ビルドとデプロイ**: 設定ファイルを更新したので、NLSRを再起動する必要があります。

2. **テスト**: 新しい設定で負荷分散が適切に機能するか確認します。

3. **調整**: 必要に応じて、`processing-weight`をさらに調整します（例: 80, 90, 110, 120など）。

