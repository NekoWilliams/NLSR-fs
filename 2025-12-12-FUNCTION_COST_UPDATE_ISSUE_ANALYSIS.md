2025-12-12

# FunctionCost更新が起こらない原因の分析

## 問題の概要

5分間の負荷テストで、FunctionCostが一定値を維持し、更新されなかった。

## 検証結果

### 1. サイドカーログの状況

#### node1
- **ログファイルサイズ**: 0バイト（空）
- **エントリ数**: 0
- **状態**: ログファイルが空のため、ServiceFunctionInfoが更新されない

#### node2
- **ログファイルサイズ**: 1173バイト
- **エントリ数**: 3
- **最新エントリ**: 2025-12-17 14:57:17.949908
- **状態**: ログファイルにエントリがあるが、更新がスキップされている

### 2. ログ監視の動作

#### ログ監視の間隔
- **監視間隔**: 5秒間隔（5000ms）
- **動作**: 正常に動作している

#### ログファイルの変更検出
```
DEBUG: [nlsr.SidecarStatsHandler] Log monitoring check triggered
DEBUG: [nlsr.SidecarStatsHandler] Current log file hash: 7154305393529903... (size: 1173 bytes), last hash: 7154305393529903...
DEBUG: [nlsr.SidecarStatsHandler] Log file unchanged, skipping update
```

**問題点**: ログファイルのハッシュが変わっていないため、更新がスキップされている。

### 3. NameLSAの状態

```
DEBUG: [nlsr.lsa.NameLsa] wireEncode: Encoding 0 Service Function info entries
```

**問題点**: NameLSAにServiceFunctionInfoが0エントリしか含まれていない。

### 4. ログファイルのタイムスタンプ

- **最新エントリ**: 2025-12-17 14:57:17.949908
- **現在時刻**: 2025-12-17 15:03:00頃（推定）
- **経過時間**: 約6分

**問題点**: 最新エントリが6分以上前のため、`utilization-window-seconds`（60秒）の範囲外になっている可能性がある。

## 原因の分析

### 原因1: ログファイルの変更検出が機能していない

**現象**: ログファイルのハッシュが変わっていないため、更新がスキップされている。

**考えられる理由**:
1. ログファイルのハッシュ計算方法に問題がある
2. ログファイルが実際に変更されていない（新しいエントリが追加されていない）
3. ハッシュ計算のタイミングの問題

### 原因2: ログエントリが古すぎる

**現象**: 最新エントリが6分以上前のため、`utilization-window-seconds`（60秒）の範囲外。

**影響**:
- `parseSidecarLogWithTimeWindow`が最新エントリのタイムスタンプを基準に60秒のウィンドウを設定する
- しかし、最新エントリが60秒以上前の場合、ウィンドウ内にエントリが存在しない可能性がある
- その結果、`processingTime = 0`が設定され、FunctionCostが0になる

### 原因3: トラフィックが少ない

**現象**: 5分間で3リクエストのみ。

**影響**:
- トラフィックが少ないため、ログファイルが更新されない
- ログファイルが更新されないため、ハッシュが変わらない
- ハッシュが変わらないため、更新がスキップされる

### 原因4: node1のログファイルが空

**現象**: node1のログファイルが0バイト（空）。

**影響**:
- node1にはトラフィックが到達していない
- そのため、ログファイルが空のまま
- ServiceFunctionInfoが更新されない

## 解決策

### 解決策1: ログファイルの変更検出を改善

1. **ファイルサイズの変更も検出する**: ハッシュだけでなく、ファイルサイズの変更も検出する
2. **タイムスタンプの変更を検出する**: ファイルのmtimeをチェックする
3. **強制的に再読み込みする**: 一定時間ごとに強制的にログファイルを再読み込みする

### 解決策2: トラフィック生成を強化

1. **より多くのトラフィックを生成する**: 5分間で3リクエストでは不十分
2. **リクエスト間隔を短くする**: 0.5秒間隔ではなく、0.1秒間隔など
3. **複数のプロセスから同時にリクエストを送信する**

### 解決策3: ログファイルの監視間隔を調整

1. **監視間隔を短くする**: 5秒間隔から1秒間隔に変更
2. **強制的に更新する**: 一定時間ごとに強制的に更新する

### 解決策4: スタイルデータの処理を改善

1. **古いエントリの処理**: 60秒以上前のエントリでも、FunctionCostを計算する
2. **デフォルト値の設定**: エントリがない場合のデフォルト値を設定する

## 推奨される対応

1. **トラフィック生成の強化**: より多くのトラフィックを生成して、ログファイルを更新する
2. **ログファイルの変更検出の改善**: ファイルサイズやタイムスタンプの変更も検出する
3. **強制的な更新**: 一定時間ごとに強制的にログファイルを再読み込みする

## 次のステップ

1. トラフィック生成スクリプトを改善して、より多くのトラフィックを生成する
2. ログファイルの変更検出ロジックを改善する
3. 強制的な更新メカニズムを実装する

